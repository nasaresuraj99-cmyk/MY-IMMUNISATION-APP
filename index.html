<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facility Immunization Tracker (FIT)</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/x-icon" href="icons/icon-72x72.png">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <img src="icons/icon-72x72.png" alt="FIT Logo" class="nav-logo">
                <h1>FIT</h1>
                <span class="nav-subtitle">Facility Immunization Tracker</span>
            </div>
            <div class="nav-menu" id="navMenu">
                <a href="#" onclick="showView('dashboard')" class="nav-link">Dashboard</a>
                <a href="#" onclick="showView('children')" class="nav-link">Children</a>
                <a href="#" onclick="showView('facility')" class="nav-link">Facility</a>
                <a href="#" onclick="showView('reports')" class="nav-link">Reports</a>
                <a href="#" onclick="showView('audit')" class="nav-link">Audit Logs</a>
                <button class="btn-logout" onclick="logout()" id="logoutBtn">Logout</button>
            </div>
            <button class="nav-toggle" onclick="toggleMenu()">â˜°</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <!-- Login View -->
        <div id="loginView" class="view active">
            <div class="login-container">
                <div class="login-card">
                    <h2>Welcome to FIT</h2>
                    <p class="login-subtitle">Facility Immunization Tracker</p>
                    
                    <div class="login-form">
                        <input type="email" id="email" placeholder="Email" class="form-input">
                        <input type="password" id="password" placeholder="Password" class="form-input">
                        <button onclick="login()" class="btn btn-primary">Login</button>
                        <button onclick="showRegister()" class="btn btn-secondary">Register Facility</button>
                        
                        <div class="super-admin-login">
                            <p>Super Admin Access:</p>
                            <button onclick="useSuperAdminCredentials()" class="btn-admin">Use Super Admin Account</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Register View -->
        <div id="registerView" class="view">
            <div class="form-container">
                <h2>Register New Facility</h2>
                <div class="form-group">
                    <input type="email" id="regEmail" placeholder="Email" class="form-input">
                    <input type="password" id="regPassword" placeholder="Password (min. 6 characters)" class="form-input">
                    <input type="text" id="facilityName" placeholder="Facility Name" class="form-input">
                    <select id="facilityRegion" class="form-input">
                        <option value="">Select Region</option>
                        <option value="ashanti">Ashanti</option>
                        <option value="greater-accra">Greater Accra</option>
                        <option value="eastern">Eastern</option>
                        <option value="central">Central</option>
                        <option value="western">Western</option>
                        <option value="volta">Volta</option>
                        <option value="northern">Northern</option>
                        <option value="upper-east">Upper East</option>
                        <option value="upper-west">Upper West</option>
                        <option value="bono">Bono</option>
                        <option value="ahafo">Ahafo</option>
                        <option value="savannah">Savannah</option>
                        <option value="north-east">North East</option>
                    </select>
                    <input type="text" id="facilityDistrict" placeholder="District" class="form-input">
                    <input type="text" id="facilityContact" placeholder="Contact Number" class="form-input">
                    <button onclick="registerFacility()" class="btn btn-primary">Register Facility</button>
                    <button onclick="showLogin()" class="btn btn-secondary">Back to Login</button>
                </div>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboardView" class="view">
            <div class="dashboard-header">
                <h2>Dashboard</h2>
                <div class="user-info" id="userInfo"></div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Children</h3>
                    <div class="stat-number" id="totalChildren">0</div>
                </div>
                <div class="stat-card">
                    <h3>Due for Vaccination</h3>
                    <div class="stat-number" id="dueVaccinations">0</div>
                </div>
                <div class="stat-card">
                    <h3>Defaulters</h3>
                    <div class="stat-number" id="defaulters">0</div>
                </div>
                <div class="stat-card">
                    <h3>Coverage Rate</h3>
                    <div class="stat-number" id="coverageRate">0%</div>
                </div>
            </div>

            <div class="dashboard-sections">
                <div class="section-card">
                    <h3>Recent Children</h3>
                    <div id="recentChildren" class="children-list"></div>
                </div>
                
                <div class="section-card">
                    <h3>Upcoming Vaccinations (Next 7 Days)</h3>
                    <div id="upcomingVaccinations" class="vaccination-list"></div>
                </div>
                
                <div class="section-card full-width">
                    <h3>Defaulter List</h3>
                    <div id="defaulterList" class="defaulter-list"></div>
                </div>
            </div>
            
            <!-- Super Admin Only: System Overview -->
            <div id="systemOverview" class="section-card full-width" style="display: none;">
                <h3>System Overview (Super Admin)</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Facilities</h3>
                        <div class="stat-number" id="totalFacilities">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>System Coverage</h3>
                        <div class="stat-number" id="systemCoverage">0%</div>
                    </div>
                    <div class="stat-card">
                        <h3>System Defaulters</h3>
                        <div class="stat-number" id="systemDefaulters">0</div>
                    </div>
                </div>
                <div id="facilitiesList" class="facilities-list"></div>
            </div>
        </div>

        <!-- Children Management View -->
        <div id="childrenView" class="view">
            <div class="view-header">
                <h2>Children Management</h2>
                <button onclick="showAddChild()" class="btn btn-primary">Add New Child</button>
            </div>
            
            <div class="search-container">
                <input type="text" id="searchChild" placeholder="Search by name..." class="form-input search-input" oninput="searchChildren()">
                <select id="filterStatus" class="form-input" onchange="searchChildren()">
                    <option value="">All Status</option>
                    <option value="up-to-date">Up to Date</option>
                    <option value="due">Due Soon</option>
                    <option value="overdue">Overdue</option>
                </select>
            </div>
            
            <div id="childrenList" class="children-table"></div>
        </div>

        <!-- Add/Edit Child View -->
        <div id="childFormView" class="view">
            <div class="form-container">
                <h2 id="childFormTitle">Add New Child</h2>
                <div class="form-group">
                    <input type="text" id="childName" placeholder="Full Name" class="form-input" required>
                    <input type="date" id="childDOB" class="form-input" required>
                    <select id="childSex" class="form-input" required>
                        <option value="">Select Sex</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                    <input type="text" id="childGuardian" placeholder="Guardian Name" class="form-input">
                    <input type="tel" id="childContact" placeholder="Guardian Contact" class="form-input">
                    <textarea id="childAddress" placeholder="Address" class="form-input" rows="3"></textarea>
                    
                    <h3>Vaccination Status</h3>
                    <div id="vaccineChecklist" class="vaccine-checklist"></div>
                    
                    <div class="form-actions">
                        <button onclick="saveChild()" class="btn btn-primary">Save Child</button>
                        <button onclick="showView('children')" class="btn btn-secondary">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Facility Management View -->
        <div id="facilityView" class="view">
            <div class="view-header">
                <h2>Facility Management</h2>
                <button onclick="showEditFacility()" class="btn btn-primary">Edit Facility</button>
            </div>
            
            <div id="facilityInfo" class="facility-info"></div>
            
            <!-- Super Admin Only: All Facilities -->
            <div id="allFacilitiesSection" class="section-card" style="display: none;">
                <h3>All Facilities</h3>
                <div id="allFacilitiesList" class="facilities-table"></div>
            </div>
        </div>

        <!-- Edit Facility Form -->
        <div id="facilityFormView" class="view">
            <div class="form-container">
                <h2 id="facilityFormTitle">Edit Facility</h2>
                <div class="form-group">
                    <input type="text" id="editFacilityName" placeholder="Facility Name" class="form-input">
                    <select id="editFacilityRegion" class="form-input">
                        <option value="">Select Region</option>
                        <!-- Regions will be populated -->
                    </select>
                    <input type="text" id="editFacilityDistrict" placeholder="District" class="form-input">
                    <input type="text" id="editFacilityContact" placeholder="Contact Number" class="form-input">
                    
                    <div class="form-actions">
                        <button onclick="updateFacility()" class="btn btn-primary">Update Facility</button>
                        <button onclick="showView('facility')" class="btn btn-secondary">Cancel</button>
                        <button onclick="deleteFacility()" class="btn btn-danger" id="deleteFacilityBtn" style="display: none;">Delete Facility</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports View -->
        <div id="reportsView" class="view">
            <div class="view-header">
                <h2>Reports</h2>
                <div class="report-actions">
                    <button onclick="exportToCSV()" class="btn btn-secondary">Export to CSV</button>
                    <button onclick="generatePDF()" class="btn btn-secondary">Generate PDF</button>
                </div>
            </div>
            
            <div class="reports-grid">
                <div class="report-card">
                    <h3>Coverage Report</h3>
                    <div id="coverageChart" class="chart-container">
                        <!-- Coverage chart will be generated here -->
                    </div>
                </div>
                
                <div class="report-card">
                    <h3>Defaulters Analysis</h3>
                    <div id="defaulterChart" class="chart-container">
                        <!-- Defaulter chart will be generated here -->
                    </div>
                </div>
                
                <div class="report-card full-width">
                    <h3>Vaccination Timeline</h3>
                    <div id="vaccineSchedule" class="schedule-container"></div>
                </div>
            </div>
        </div>

        <!-- Audit Logs View -->
        <div id="auditView" class="view">
            <div class="view-header">
                <h2>Audit Logs</h2>
                <div class="filter-container">
                    <select id="auditActionFilter" class="form-input" onchange="loadAuditLogs()">
                        <option value="">All Actions</option>
                        <option value="create">Create</option>
                        <option value="update">Update</option>
                        <option value="delete">Delete</option>
                    </select>
                    <input type="date" id="auditDateFilter" class="form-input" onchange="loadAuditLogs()">
                </div>
            </div>
            
            <div id="auditLogs" class="audit-logs"></div>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p>Loading...</p>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="toast"></div>

    <!-- Scripts -->
    <script src="firebase.js"></script>
    <script src="app.js"></script>
    
    <script>
        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registered');
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }
        
        // Install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button or notification
            setTimeout(() => {
                if (deferredPrompt) {
                    const installBtn = document.createElement('button');
                    installBtn.textContent = 'Install FIT App';
                    installBtn.className = 'btn-install';
                    installBtn.onclick = () => {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('User accepted install');
                            }
                            deferredPrompt = null;
                        });
                    };
                    document.body.appendChild(installBtn);
                    
                    setTimeout(() => {
                        installBtn.style.display = 'none';
                    }, 10000);
                }
            }, 5000);
        });
    </script>
</body>
</html>